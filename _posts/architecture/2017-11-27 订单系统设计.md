---
layout: post
title: 订单系统设计
category: 软件架构
tags: 订单
---

对于电商来说，订单业务为第一核心业务。除了订单业务外，关键业务还有支付、商品、库存、用户等相关业务。订单业务关键的是后端数据库的设计，下面分几个问题分析下。

## 分表分库 ##
分表可以纵向分表，与HBase的设计的理念有些类似，业务上的假设，很多的操作不是需要所有的列，而只是需要部分列。订单可能有的字段有时间、商品信息、价格信息、状态、物流、售后处理信息等，其中有些字段后面经常使用，而且会同时经常使用，可以把这中列单独放到一张表，其他如售后、物流的也可单独放在一张表，多张表使用主键id关联起来。

## 扩容问题 ##
如果分表分库了，那么就存在路由问题，当然也存在一致性hash的问题了，这里可以参考Redis的集群的方式，采用一种预分片技术，比如，目前的业务使用8台机器就能解决2到3年内的增长问题，那么可以采用分成32个片的方式，每个机器上先部署上4个片，等业务增长了，可以上16台机器，修改下路由扩容工作就能完成了。

这里如果业务增长飞快，到了32个机器都解决不了的时候，就需要重新对数据进行hash了，这里可以参考java中的HashMap的方式，这也是实例（片）的数目为什么一直是2的次幂个，Redis中，实例个数也是2的次幂个，在扩容的时候，最好是直接扩大一倍的实例数目（不一定是物理主机数目），这样数据迁移的时候有一半的数据不用动，而只迁移一半的数据就可以了。

## 订单号设计 ##
订单号设计需要考虑的点自己想到的如下：

- 长度尽可能短，这样不论是索引效率、存储空间、客户人员使用方便性上都要好
- 最好是纯数字，京东与淘宝都是纯数字，索引效率高
- 要包括用户信息，不一定是完整的用户id，但是要一定能关联起来，分库的时候用户对应的订单最好在一个库中，效率高，不用跨库。
- 安全性上，最好不让别人看出来设计规则，否则能看出你的业务量
- 最好在单个库内订单号是单调的，主要是从数据库角度出发，Mysql的Innodb如果单调的订单号，写入效率高
- 生成速度一定要快