---layout: posttitle: Java虚拟机category: Java相关tags: Java---进阶高级程序员的必经之路，可能平时写代码用不大上，但是在一定场景下调节jvm参数能够进行系统的调优。就像存储系统一样，要么对支持小文件优化的好点，要么对支持大文件优化的好点，很难两者都兼得。jvm也一样，不同场景下，可能有不同的运行参数。## 如果要自己设计一个jvm，需要考虑哪些方面呢？ ##### 如何成为一个“机”（虚拟机）？ ###JVM的导出宣传的口号“一次编译到处运行”，那考虑操作系统的兼容性，应该是一大部分工作，如何设计出公共的抽象的接口，在linux下有POSIX(Portable Operating System Interface)接口，虽然也不是所有linux都是依照这规范设计。对应的JVM应该有一套标准，底层的虚拟机换了，上面跑的程序代码应该是透明的。那如果自己定义虚拟机，首先要有一套specification。如何定义这specification呢？最简单的就是按照c++的ACE的那套接口，这只是有了接口，能做到“代码可以到处编译”，还是有编译的过程，那如何先编译成中间的二进制文件，能够到处运行呢？

既然都叫虚拟机了，那就在参考Linux操作系统的样子，做个虚拟的操作系统吧，linux的内核有驱动、文件系统、内存管理、进行调度、进程通信等模块，可以参考[linux操作系统及内核](https://wangzhenyagit.github.io/2012/04/18/linux-core.html)。JVM不需要的就是各种驱动了，也不需要啥工作量直接用上面的各种系统调用就好了。

文件系统其实还好，对宿主的操作系统进行封装，都有目录、文件的概念。

进行通信，这也是照葫芦画瓢，提供锁、信号量、condition_wait方式就可以了。

进程调度也是一样，与linux操作系统上没有特别大的差别。

最最不同的就是这内存管理了，自动的垃圾回收。### 如何实现垃圾回收？ ###首先，基本的内存模型也是按照linux的套路，分为栈和堆，堆是放大对象也是回收的关键，栈是临时的放一些不是new出来的东西，在退出作用域直接释放掉。Java中都是对象，暂时只考虑针对Java的虚拟的设计，JVM也可以是很多语言的虚拟机如最近火的Scale。如果都是对象，那回收的单位都是对象。回收大概分为两步，分析那些内存（对象需要回收），到了回收的时候，发个任务一次批量回收。这两步中会涉及到以下问题：- 分析待回收对象算法- 回收操作的触发算法- 如何回收（单线程or并发）分析回收对象的算法，这算法其实还好实现，因为JVM管理了所有的对象，对象创建后一般有引用关系，那么可以从程序运行开始，记录所有的static的对象，和main方法中的对象，这些对象作为根对象，像一颗树一样向上生长，如果一个对象没有任何的对象对他引用，那就是个孤零零的东西，用户也不会访问到，也自然没什么用了，就可以标记下，等待删除了。回收操作的触发算法，可以定时周期，可以是使用到了一定阈值的，另外也可以考虑操作系统的繁忙情况，对象创建的速度，创建的加速度等。然后就是各种搞定上面的问题后，需要在考虑优化的事情，因为回收的是对象，那可以用对象的什么特性来进行优化？对象的