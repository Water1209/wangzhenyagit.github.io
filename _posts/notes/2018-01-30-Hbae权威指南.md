---
layout: post
title: 《Hbae权威指南》读书笔记
category: 读书笔记
tags: Hbae
---

书为2013年9月的第一版。

### 列式数据库 ###

- 基于假设：“对于特定的查询不是所有的值都是必须的”。这个假设不仅说明了一般的适用场景，而且Hbase中很多的优化都是基于列的优化，使用的时候要先考虑是否用到了此特性，发挥了Hbase的特长。
- 如果有了以上假设，那么列式存储的优点是什么呢？——减少IO。而且列相似性很高，便于压缩，对于列式存储而言，压缩是很重的技术。压缩了，从磁盘的IO会减少，虽然会有一定的CPU的浪费，但是总性能是提高的。优点类似于CPU或IO，ES中也很多类似的设计，如文档同步后再进行索引重建，还有ES的FST结构。

### RDBMS的等待和死锁与事务和并发的关系 ###
> RDBMS的等待和死锁的出现频率，与事务和并发的增加并不是线性关系，准确地说，与并发数目的平方以及事务规模的3次方甚至5次方相关。

### 与MapReduce存在的一个在一起的两个理由 ###
- Hbase并不是CPU密集型的，很多时候是在顺序的读磁盘。而Hbae+Spark或MapReduce能够利用机器上的CPU资源，更加充分的利用硬件。
- 部署在一起，从本地读取，IO效率高，而且节省了网络的IO资源。

### 行键在HFile中的定位作用 ###
> 把HFile打开并加载到内存中时，索引信息会优先加载到内存中，每个块的大小默认是64KB。

> 每一个HFile都有一个块索引，通过一个磁盘查找就可以实现查询。首先，在内存的快索引中进行二分查找，确定可能包含给定键的块，然后读取磁盘块找到实际要找的键。

### master节点的工作 ###
> 主服务器不是实际数据存储或者检索路径的组成部分，它仅提供了负载均衡和集群管理，不为region服务器或者客户端提供任何的数据服务，因此是轻量级的服务器。此外，主服务器还提供了元数据的管理操作，如建表和创建列族

路由信息，由Zk和root表和mete表提供，master并不提供。在ES中可以有专门做路由的transport节点，有类似也的单独的master节点，配置node.master为true的时候，有可能被选举为主节点。

而且，ES也可以配置一个节点为专门的“路由节点”，node.master和node.data都设置为false的时候，该节点可以作为客户端节点，可以响应用户的情况，把相关操作发送到其他节点。另外，不同的时，ES还有一种tribe节点，能够连接其他的集群进行查询操作。

此外，ES还有一种节点，只做协调作用：

> 收到用户请求的节点被称为协调节点，请求的处理可以分为两个阶段：  
> 1. scatter 阶段。协调节点将请求转发给持有数据的节点。每个节点在本地执行请求，并将结果返回给协调节点。  
> 2. gather 阶段。协调节点将收到的结果归并，然后返回给用户。  
> 每个节点都是隐式的协调节点，node.master, node.data 和 node.ingest 都为 false的节点是纯粹的协调节点。

参考：[深入理解Elasticsearch：概念](https://www.jianshu.com/p/2a18fdce61cf)

### 单台服务器的region大小和数目 ###
> 按照现在的硬件能力，每台服务器的最佳加载数量差不多还是10~1000，但每个region的最佳大小是1GB~2GB

> region的数量和每个region的最佳存储大小取决于单台服务器的有效处理能力。

上面的“现在”指的是2013年。后面一句的“有效处理能力”也太抽象了。region体积大，数目少，IO可能就不会均匀，数据分布也不会均匀，容易产生热点问题，region体积小，数目多，维护region的信息会占用很多内存，而且集群为了很多region对master压力大，会相对频繁的移动region，集群也会不稳定。直接参考官网配置[Bigger Regions中](http://hbase.apache.org/0.94/book/important_configurations.html)的一些文字具体原因可以参考原文：

> Consider going to larger regions to cut down on the total number of regions on your cluster. Generally less Regions to manage makes for a smoother running cluster (You can always later manually split the big Regions should one prove hot and you want to spread the request load over the cluster). A lower number of regions is preferred, generally in the range of 20 to low-hundreds per RegionServer. Adjust the regionsize as appropriate to achieve this number.
> 
> Typically you want to keep your region count low on HBase for numerous reasons. Usually right around 100 regions per RegionServer has yielded the best results.

### 磁盘 ###
> 通常情况下，用户应该保证每个磁盘上至少有一个核，所以在8核心的机器上增加6块磁盘是较优的，更多的磁盘可能不会带来显著的性能提升。
> 
> 对于slave节点来说（Region Server、DataNode、TaskTracker）不推荐使用RAID模式，而是使用JBOD模式。
> 
> 对master节点（NameNode、SecondNameNode、Hbase Master、JobTracker），通常的配置是RAID1+0或RAID0+1。
> 
> 一般更推荐使用SATA驱动器，因为SATA比SAS更节省成本，虽然SAS安全新高于SATA。

京东查了下，7200的盘，1T的SATA盘只要300块，而SAS的要将近1000块。

### 操作系统配置 ###
> 禁用文件的访问时间可以大幅度提高磁盘的读取性能。
> 
> 集群中节点时间必须是一致的，仅仅一分钟的偏差就有可能产生莫名其妙的行为。

MongoDB不知道是否需要禁用这时间。

